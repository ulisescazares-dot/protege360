<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://cdn.tailwindcss.com"></script>
<title>Protege360</title>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="w-full max-w-md bg-white shadow-xl rounded-xl overflow-hidden">

    <div class="bg-blue-900 text-white p-4">
        <h2 class="text-lg font-semibold">Asistente de Protección Financiera</h2>
        <p class="text-sm opacity-80">Evaluación rápida y confidencial</p>
    </div>

    <div id="messages" class="p-4 h-96 overflow-y-auto space-y-3 bg-gray-50"></div>

    <div class="p-4 border-t flex space-x-2">
        <input id="input" type="text"
               class="flex-1 border rounded-lg px-3 py-2"
               placeholder="Escribe tu respuesta...">
        <button onclick="sendMessage()"
                class="bg-blue-900 text-white px-4 py-2 rounded-lg">
            Enviar
        </button>
    </div>

</div>

<script>

let state = {"level":"start","data":{}};

function addMessage(text, sender){
    const div=document.createElement("div");
    div.className=sender==="bot"
        ?"bg-blue-100 text-blue-900 p-3 rounded-lg w-fit max-w-xs"
        :"bg-blue-900 text-white p-3 rounded-lg w-fit max-w-xs ml-auto";
    div.innerText=text;
    document.getElementById("messages").appendChild(div);
    div.scrollIntoView();
}

function sendMessage(textOverride=null){
    const input=document.getElementById("input");
    const message=textOverride||input.value;
    if(!message) return;

    addMessage(message,"user");
    input.value="";

    fetch("/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:message,state:state})
    })
    .then(res=>res.json())
    .then(data=>{
        state=data.state;
        addMessage(data.reply,"bot");

        if(data.options){
            data.options.forEach(opt=>{
                const btn=document.createElement("button");
                btn.className="block w-full mt-2 bg-blue-900 text-white px-4 py-2 rounded-lg";

                btn.innerText=opt;
                btn.onclick=()=>sendMessage(opt);

                document.getElementById("messages").appendChild(btn);
            });
        }
    });
}

fetch("/chat",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:"",state:state})
})
.then(res=>res.json())
.then(data=>{
    state=data.state;
    addMessage(data.reply,"bot");
});

</script>

</body>
</html>
