<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div class="flex min-h-screen">

    <!-- Sidebar -->
    <div class="w-64 bg-blue-900 text-white p-6">
        <h2 class="text-2xl font-bold mb-8">Protege360</h2>
        <p class="mb-4">Usuario: {{ username }}</p>
        <p class="mb-8 capitalize">{{ role }}</p>

        <a href="/logout"
           class="bg-white text-blue-900 px-4 py-2 rounded block text-center">
            Cerrar sesi칩n
        </a>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-8">

        <h1 class="text-3xl font-bold text-blue-900 mb-6">
            Dashboard
        </h1>

        {% if role == "director" and metrics %}

        <div class="bg-yellow-200 p-4 mb-4">
    DEBUG OVERDUE: {{ metrics.overdue }}
    <br>
    DEBUG RESPONSE: {{ metrics.response_times }}
</div>

        <!-- M칄TRICAS GENERALES -->
        <div class="grid grid-cols-3 gap-6 mb-8">

            <div class="bg-white shadow rounded p-6">
                <h3 class="text-gray-500">Total Leads</h3>
                <p class="text-3xl font-bold text-blue-900">
                    {{ metrics.total }}
                </p>
            </div>

            <div class="bg-white shadow rounded p-6">
                <h3 class="text-gray-500">Cerrados</h3>
                <p class="text-3xl font-bold text-green-600">
                    {{ metrics.closed }}
                </p>
            </div>

            <div class="bg-white shadow rounded p-6">
                <h3 class="text-gray-500">Tasa de Cierre</h3>
                <p class="text-3xl font-bold text-blue-900">
                    {{ metrics.close_rate }}%
                </p>
            </div>

        </div>

        <!-- ALERTAS -->
        <div class="grid grid-cols-2 gap-6 mb-8">

            <div class="bg-red-100 shadow rounded p-6">
                <h3 class="text-red-700 font-semibold">
                    Leads sin contactar +2h
                </h3>

                <p class="text-4xl font-bold text-red-900 mt-2">
                    {{ metrics.overdue or 0 }}
                </p>

                <p class="text-sm text-gray-600 mt-2">
                    Requieren atenci칩n inmediata
                </p>
            </div>

            <div class="bg-green-100 shadow rounded p-6">
                <h3 class="text-green-700 font-semibold mb-3">
                    Promedio respuesta por agente (min)
                </h3>

                {% if metrics.response_times %}
                    {% for agent in metrics.response_times %}
                        <div class="flex justify-between border-b py-1">
                            <span class="font-medium">
                                {{ agent[0] }}
                            </span>
                            <span class="font-bold">
                                {{ agent[1] | round(1) }} min
                            </span>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-600">
                        Sin datos a칰n
                    </p>
                {% endif %}

            </div>

        </div>

        <!-- GR츼FICAS -->
        <div class="grid grid-cols-2 gap-8 mb-8">

            <div class="bg-white shadow rounded p-6">
                <h3 class="mb-4 font-semibold text-blue-900">
                    Leads por Agente
                </h3>
                <canvas id="agentChart"></canvas>
            </div>

            <div class="bg-white shadow rounded p-6">
                <h3 class="mb-4 font-semibold text-blue-900">
                    Leads por Estado
                </h3>
                <canvas id="statusChart"></canvas>
            </div>

        </div>

        <script>
        const agentChart = new Chart(
            document.getElementById('agentChart'),
            {
                type: 'bar',
                data: {
                    labels: {{ metrics.by_agent | map(attribute=0) | list | safe }},
                    datasets: [{
                        data: {{ metrics.by_agent | map(attribute=1) | list | safe }},
                        backgroundColor: '#1E3A8A'
                    }]
                }
            }
        );

        const statusChart = new Chart(
            document.getElementById('statusChart'),
            {
                type: 'doughnut',
                data: {
                    labels: {{ metrics.by_status | map(attribute=0) | list | safe }},
                    datasets: [{
                        data: {{ metrics.by_status | map(attribute=1) | list | safe }},
                        backgroundColor: [
                            '#1E3A8A',
                            '#2563EB',
                            '#60A5FA',
                            '#10B981',
                            '#EF4444'
                        ]
                    }]
                }
            }
        );
        </script>

        {% endif %}

        <!-- TABLA DE LEADS -->
        <div class="bg-white shadow rounded p-6">
            <h2 class="text-xl font-semibold mb-4 text-blue-900">
                Leads
            </h2>

            <table class="w-full text-left">
                <thead>
                    <tr class="border-b">
                        <th class="py-2">Nombre</th>
                        <th>Score</th>
                        <th>Prioridad</th>
                        <th>Tel칠fono</th>
                        <th>Estado</th>
                        <th>Acci칩n</th>
                    </tr>
                </thead>

                <tbody>
                {% for lead in leads %}
                <tr class="border-b">

                    <td class="py-2 font-semibold">
                        {{ lead[1] }}
                    </td>

                    <!-- SCORE CON COLOR -->
                    <td>
                        {% set score = lead[14] or 0 %}

                        {% if score >= 85 %}
                            <span class="bg-red-600 text-white px-2 py-1 rounded">
                                游댠 {{ score }}
                            </span>
                        {% elif score >= 70 %}
                            <span class="bg-yellow-500 text-white px-2 py-1 rounded">
                                游리 {{ score }}
                            </span>
                        {% else %}
                            <span class="bg-blue-600 text-white px-2 py-1 rounded">
                                游댯 {{ score }}
                            </span>
                        {% endif %}
                    </td>

                    <!-- PRIORITY -->
                    <td>
                        {% if lead[15] == "Caliente" %}
                            <span class="text-red-600 font-bold">游댠 Caliente</span>
                        {% elif lead[15] == "Medio" %}
                            <span class="text-yellow-600 font-bold">游리 Medio</span>
                        {% else %}
                            <span class="text-blue-600 font-bold">游댯 Fr칤o</span>
                        {% endif %}
                    </td>

                    <td>{{ lead[10] }}</td>
                    <td>{{ lead[12] }}</td>

                    <td>
                        <a href="/lead/{{ lead[0] }}"
                           class="bg-blue-900 text-white px-3 py-1 rounded">
                            Ver
                        </a>
                    </td>

                </tr>
                {% endfor %}
                </tbody>

            </table>
        </div>

    </div>
</div>

</body>
</html>
